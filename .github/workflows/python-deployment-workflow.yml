name: Python Deployment Workflow
#!

run-name: ${{ github.actor }} - ${{ github.sha }}


env:
  PythonVersion: 3.8


on: 
  push: 
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]


jobs:
  python-ci:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5


    - uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PythonVersion }}
    

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage flake8


    - name: Run migrations
      run: python manage.py migrate --noinput

    - name: Run tests with coverage
      run: coverage run manage.py test


    - name: Generate coverage report
      run: coverage run manage.py test

    - name: Check code style
      run: flake8 . --show-source --statistics
      continue-on-error: true


    - name: Check code complexity
      run: flake8 . --max-complexity=10
      continue-on-error: true  

    - name: Display coverage report
      run: coverage report

    - name: Upload Python files as artifacts
      uses: actions/upload-artifact@v2
      with:
        name: python-files
        path: |
          manage.py
          requirements.txt
          src/
